on:
    push:
      branches:
        - main
        - develop
    pull_request:
      branches:
        - main
        - develop
env:
    BACKEND_ENV: ./.env.backend
    FRONTEND_ENV: frontend/.env.frontend


jobs:
    build:
        name: Build and Test Live Streaming Platform
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Load frontend .env
              run: |
                cp $FRONTEND_ENV frontend/.env

            - name: Set up Node.js 22
              uses: actions/setup-node@v4
              with:
                node-version: '22'

            - name: Install & Build Frontend
              run: |
                cd frontend
                npm ci
                npm run build
        
            - name: Upload Frontend Artifact
              uses: actions/upload-artifact@v4
              with:
                name: frontend-dist
                path: frontend/dist/

            - name: Load backend .env
              run: |
                cp $BACKEND_ENV .env

            - name: Setup Java 21
              uses: actions/setup-java@v4
              with:
                distribution: 'temurin'
                java-version: '21'
                
            - name: Setup Gradle
              uses: gradle/setup-gradle@v4
              
            - name: Build & Test Backend
              run: ./gradlew clean build
            
            - name: Upload Backend Artifact
              uses: actions/upload-artifact@v4
              with:
                name: backend-jar
                path: build/libs/*.jar

# 추후 구현                
# 추후 nginx-rtmp(실시간 스트리밍 서버) 설치 및 구현
#deploy:
#    needs: build
#    runs-on: ubuntu-latest
#    steps:
#        - uses: actions/download-artifact@v4
#          with: { name: backend-jar }

#        - uses: actions/download-artifact@v4
#          with: { name: frontend-dist }
    
#        - name: Deploy to Server
#          uses: appleboy/ssh-action@v0.1.7
#          with:
#            host: ${{ secrets.EC2_HOST }}
#            username: ubuntu
#            key: ${{ secrets.SSH_KEY }}
#            script: |
#              pkill -f 'app.jar' || true
#              mv backend-*.jar ~/app/app.jar
#              nohup java -jar ~/app/app.jar &
#              rm -rf /usr/share/app/static/*
#              cp -r frontend/dist/* /usr/share/app/static/
#        
#deploy-rtmp:
#    needs: build
#    runs-on: ubuntu-latest
#    steps:
#        - name: Checkout code
#          uses: actions/checkout@v4

#        - name: Deploy nginx-rtmp to Server
#          uses: appleboy/ssh-action@v0.1.7
#          with:
#            host: ${{ secrets.EC2_HOST_STREAMING }}
#            username: ubuntu
#            key: ${{ secrets.SSH_KEY_STREAMING }}
#            script: |
#              # Docker Compose 파일 복사
#              cd ~/live-platform
#              git pull origin main
          
#              # nginx-rtmp 서비스만 재시작
#              docker-compose down nginx-rtmp
#              docker-compose up -d nginx-rtmp
          
#              # 스트림 데이터 디렉토리 권한 설정
#              sudo mkdir -p /tmp/stream/hls
#              sudo chmod 755 /tmp/stream/hls
          
#              # 방화벽 설정 (RTMP 포트)
#              sudo ufw allow 1935/tcp
#              sudo ufw allow 8081/tcp
          
#              echo "nginx-rtmp 스트리밍 서버 배포 완료"