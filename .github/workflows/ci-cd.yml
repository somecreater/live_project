name: CI-CD RUNNING
on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main", "develop" ]


jobs:
    build:
        name: Build and Test Live Streaming Platform
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v6
              
# ---------------- Frontend ----------------

            - name: Create frontend .env file
              run: |
                cat << 'EOF' | base64 --decode > front/live/.env
                ${{ secrets.FRONTEND_ENV }}
                EOF

            - name: Set up Node.js 22
              uses: actions/setup-node@v6
              with:
                node-version: '22'

            - name: Install & Build Frontend
              run: |
                cd front/live
                npm ci
                npm run build
        
            - name: Upload Frontend Artifact
              uses: actions/upload-artifact@v5
              with:
                name: frontend-dist
                path: front/live/dist/

# ---------------- Backend ----------------

            - name: Create backend .env file
              run: |
                cat << 'EOF' | base64 --decode > .env
                ${{ secrets.BACKEND_ENV }}
                EOF

            - name: Setup Java 21
              uses: actions/setup-java@v5
              with:
                distribution: 'temurin'
                java-version: '21'
                
            - name: Setup Gradle
              uses: gradle/actions/setup-gradle@v5

            - name: Grant execute permission for gradlew
              run: chmod +x gradlew

            - name: Build & Test Backend
              run: ./gradlew clean build -x test
            
            - name: Upload Backend Artifact
              uses: actions/upload-artifact@v5
              with:
                name: backend-jar
                path: build/libs/*.jar

            - name: Cleanup
              run: rm -f .env front/live/.env

# ===== 배포 단계 (추후 구현) =====

# Spring Boot + React API 서버 배포
#deploy-api:
#    needs: build
#    runs-on: ubuntu-latest
#    steps:
#        - name: Download Artifacts
#          uses: actions/download-artifact@v4
#          with:
#            name: backend-jar
#
#        - name: Download Frontend Artifacts
#          uses: actions/download-artifact@v4
#          with:
#            name: frontend-dist
#    
#        - name: Deploy Spring Boot + React to API Server
#          uses: appleboy/ssh-action@v0.1.7
#          with:
#            host: ${{ secrets.EC2_HOST }}
#            username: ubuntu
#            key: ${{ secrets.SSH_KEY }}
#            script: |
#              # 기존 애플리케이션 중지
#              sudo systemctl stop live-api || true
#              
#              # 새 JAR 파일 배포
#              sudo cp backend-*.jar /opt/live-api/app.jar
#              sudo chown live-api:live-api /opt/live-api/app.jar
#              
#              # React 빌드 파일 배포
#              sudo rm -rf /opt/live-api/static/*
#              sudo cp -r frontend-dist/* /opt/live-api/static/
#              sudo chown -R live-api:live-api /opt/live-api/static/
#              
#              # 애플리케이션 재시작
#              sudo systemctl start live-api
#              
#              # 헬스체크
#              sleep 10
#              curl -f http://localhost:8080/actuator/health || exit 1
#              
#              echo "Spring Boot + React API 서버 배포 완료"

# 모니터링 서버 배포
#deploy-monitoring:
#    needs: build
#    runs-on: ubuntu-latest
#    steps:
#        - name: Checkout code
#          uses: actions/checkout@v4
#
#        - name: Deploy Monitoring Server
#          uses: appleboy/ssh-action@v0.1.7
#          with:
#            host: ${{ secrets.EC2_HOST_MONITORING }}
#            username: ubuntu
#            key: ${{ secrets.SSH_KEY_MONITORING }}
#            script: |
#              # 프로젝트 업데이트
#              cd ~/live-monitoring-platform
#              git pull origin main
#              
#              # 모니터링 서비스 재시작
#              docker-compose -f docker-compose.monitoring.yml down
#              docker-compose -f docker-compose.monitoring.yml up -d
#              
#              # 방화벽 설정 (모니터링 포트)
#              sudo ufw allow 9090/tcp
#              sudo ufw allow 3001/tcp
#              
#              # 헬스체크
#              sleep 10
#              curl -f http://localhost:9090/-/healthy || exit 1
#              curl -f http://localhost:3001/api/health || exit 1
#              
#              echo "모니터링 서버 배포 완료"
